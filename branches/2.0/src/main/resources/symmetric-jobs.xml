<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:util="http://www.springframework.org/schema/util"
    xsi:schemaLocation="
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.0.xsd"
    default-lazy-init="true">

    <bean id="jobManager" class="org.jumpmind.symmetric.job.JobManager">
        <property name="parameterService" ref="parameterService" />
    </bean>
    
    <bean id="randomTimeSlot" class="org.jumpmind.symmetric.util.RandomTimeSlot">
        <property name="parameterService" ref="parameterService" />
    </bean>
    
    <bean id="afterMidnightTimeSlot" class="org.jumpmind.symmetric.util.AfterMidnightTimeSlot">
        <property name="parameterService" ref="parameterService" />
    </bean>    

    <util:property-path id="delayBeforeStartTimeSlotRouting"
        path="randomTimeSlot.randomValueSeededByDomainId" />
        
    <util:property-path id="delayBeforeStartTimeSlotPush"
        path="randomTimeSlot.randomValueSeededByDomainId" />
        
    <util:property-path id="delayBeforeStartTimeSlotPull"
        path="randomTimeSlot.randomValueSeededByDomainId" />
        
    <util:property-path id="millisecondsUntilTargetTime"
        path="afterMidnightTimeSlot.millisecondsUntilTargetTime" />        
        
        
    <bean id="routingJobTimer" class="org.springframework.scheduling.timer.TimerFactoryBean">
        <property name="scheduledTimerTasks">
            <list>
                <bean class="org.springframework.scheduling.timer.ScheduledTimerTask">
                    <property name="delay" ref="delayBeforeStartTimeSlotRouting" />
                    <property name="timerTask" ref="routingTimerTask" />
                </bean>
            </list>
        </property>
    </bean>
    
    <bean id="routingTimerTask" class="org.jumpmind.symmetric.job.RouterJob" scope="prototype">
        <property name="parameterService" ref="parameterService" />
        <property name="routingService" ref="routingService" />
        <property name="needsRescheduled" value="true" />
        <property name="rescheduleDelayParameter" value="job.routing.period.time.ms" />
        <property name="dataSource" ref="dataSource"/>
        <property name="jobManager" ref="jobManager"/>
    </bean>
            
    <bean id="pushJobTimer" class="org.springframework.scheduling.timer.TimerFactoryBean">
        <property name="scheduledTimerTasks">
            <list>
                <bean class="org.springframework.scheduling.timer.ScheduledTimerTask">
                    <!-- Random wait before start to stagger load -->
                    <property name="delay" ref="delayBeforeStartTimeSlotPush" />
                    <property name="timerTask" ref="pushTimerTask" />
                </bean>
            </list>
        </property>
    </bean>
    
    <bean id="pushTimerTask" class="org.jumpmind.symmetric.job.PushJob" scope="prototype">
        <property name="parameterService" ref="parameterService" />
        <property name="pushService" ref="pushService" />
        <property name="needsRescheduled" value="true" />
        <property name="rescheduleDelayParameter" value="job.push.period.time.ms" />
        <property name="dataSource" ref="dataSource"/>
        <property name="jobManager" ref="jobManager"/>
    </bean>

    <bean id="pullJobTimer" class="org.springframework.scheduling.timer.TimerFactoryBean">
        <property name="scheduledTimerTasks">
            <list>
                <bean class="org.springframework.scheduling.timer.ScheduledTimerTask">
                    <!-- Random wait before start to stagger load -->
                    <property name="delay" ref="delayBeforeStartTimeSlotPull" />
                    <property name="timerTask" ref="pullTimerTask" />
                </bean>
            </list>
        </property>
    </bean>
    
    <bean id="pullTimerTask" class="org.jumpmind.symmetric.job.PullJob" scope="prototype">
        <property name="requiresRegistration" value="false"/>
        <property name="pullService" ref="pullService" />
        <property name="needsRescheduled" value="true" />
        <property name="parameterService" ref="parameterService" />
        <property name="nodeService" ref="nodeService"/>
        <property name="rescheduleDelayParameter" value="job.pull.period.time.ms" />
        <property name="dataSource" ref="dataSource"/>
        <property name="jobManager" ref="jobManager"/>
    </bean>
    
    <bean id="purgeJobTimer" class="org.springframework.scheduling.timer.TimerFactoryBean">
        <property name="scheduledTimerTasks">
            <list>
                <bean class="org.springframework.scheduling.timer.ScheduledTimerTask">
                    <!-- Random wait before start to stagger load -->
                    <property name="delay" ref="$[sym.job.purge.period.time.ms]" />
                    <property name="period" value="$[sym.job.purge.period.time.ms]" />
                    <property name="timerTask">
                        <bean class="org.jumpmind.symmetric.job.PurgeJob">
                            <property name="purgeService" ref="purgeService" />
                            <property name="dataSource" ref="dataSource"/>
                            <property name="parameterService" ref="parameterService" />
                            <property name="jobManager" ref="jobManager"/>
                        </bean>
                    </property>
                </bean>
            </list>
        </property>
    </bean>
    
    <bean id="statisticFlushJobTimer" class="org.springframework.scheduling.timer.TimerFactoryBean">
        <property name="scheduledTimerTasks">
            <list>
                <bean class="org.springframework.scheduling.timer.ScheduledTimerTask">
                    <!-- Random wait before start to stagger load -->
                    <property name="delay" ref="delayBeforeStartTimeSlotPurge" />
                    <property name="period" value="$[sym.job.stat.flush.period.time.ms]" />
                    <property name="timerTask">
                        <bean class="org.jumpmind.symmetric.job.StatisticFlushJob">
                            <property name="statisticManager" ref="statisticManager" />
                            <property name="parameterService" ref="parameterService" />
                            <property name="jobManager" ref="jobManager"/>
                        </bean>
                    </property>
                </bean>
            </list>
        </property>
    </bean>    
    
    <bean id="syncTriggersJobTimer" class="org.springframework.scheduling.timer.TimerFactoryBean">
        <property name="scheduledTimerTasks">
            <list>
                <bean class="org.springframework.scheduling.timer.ScheduledTimerTask">
                    <property name="delay" ref="millisecondsUntilTargetTime" />
                    <!-- Run once per day -->
                    <property name="period" value="86400000" />
                    <property name="timerTask">
                        <bean class="org.jumpmind.symmetric.job.SyncTriggersJob">
                            <property name="triggerRouterService" ref="triggerRouterService" />
                            <property name="dataSource" ref="dataSource"/>
                            <property name="parameterService" ref="parameterService" />
                            <property name="jobManager" ref="jobManager"/>
                        </bean>
                    </property>
                </bean>
            </list>
        </property>
    </bean>
    
    <bean id="heartbeatJobTimer" class="org.springframework.scheduling.timer.TimerFactoryBean">
        <property name="scheduledTimerTasks">
            <list>
                <bean class="org.springframework.scheduling.timer.ScheduledTimerTask">
                    <property name="delay" value="1000" />
                    <property name="period" value="1000" />
                    <property name="timerTask">
                        <bean class="org.jumpmind.symmetric.job.HeartbeatJob">
                            <property name="requiresRegistration" value="false"/>
                            <property name="dataService" ref="dataService" />
                            <property name="dataSource" ref="dataSource"/>
                            <property name="parameterService" ref="parameterService" />
                            <property name="jobManager" ref="jobManager"/>
                        </bean>
                    </property>
                </bean>
            </list>
        </property>
    </bean>     
         
    <bean id="watchdogJobTimer" class="org.springframework.scheduling.timer.TimerFactoryBean">
        <property name="scheduledTimerTasks">
            <list>
                <bean class="org.springframework.scheduling.timer.ScheduledTimerTask">
                    <!-- run the first time after 1 minute -->
                    <property name="delay" value="60000" />
                    <!-- run once per hour -->
                    <property name="period" value="3600000" />
                    <property name="timerTask">
                        <bean class="org.jumpmind.symmetric.job.WatchdogJob">
                            <property name="requiresRegistration" value="false"/>
                            <property name="nodeService" ref="nodeService" />
                            <property name="dataSource" ref="dataSource"/>
                            <property name="parameterService" ref="parameterService" />
                            <property name="jobManager" ref="jobManager"/>
                        </bean>
                    </property>
                </bean>
            </list>
        </property>
    </bean>
</beans>
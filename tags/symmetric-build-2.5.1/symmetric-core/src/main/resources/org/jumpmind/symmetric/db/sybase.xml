<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:tx="http://www.springframework.org/schema/tx"
    xsi:schemaLocation="
    http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
    http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd" default-lazy-init="true">

    <bean id="sybaseDialect" class="org.jumpmind.symmetric.db.sybase.SybaseDbDialect"
        scope="prototype">
        <property name="primaryKeyViolationCodes" value="423,511,515,530,547,2601,2615,2714"/>
        <property name="tablePrefix" value="$[sym.sync.table.prefix]" />
        <property name="parameterService" ref="parameterService" />
        <property name="defaultSchema" value="$[sym.db.default.schema]" />
        <property name="streamingResultsFetchSize" value="$[sym.db.jdbc.streaming.results.fetch.size]" />
        <property name="sqlTemplate">
            <bean class="org.jumpmind.symmetric.db.SqlTemplate">
                
                <property name="functionInstalledSql">
                    <value>
                        <![CDATA[select count(object_name(object_id('$(functionName)')))]]>
                    </value>
                </property>
                <property name="functionTemplatesToInstall">
                    <map>
                        <entry key="base64_encode">
                            <value>
                                <!-- TODO: this will not work on sybase -->
                                <![CDATA[ 
                                create function dbo.$(functionName)(@data varbinary(1000)) returns varchar(2000) as
                                  begin
                                      declare @test varchar(50)
                                      return @test
                                  end                                
                                ]]>
                            </value>
                        </entry>
                        <entry key="triggers_disabled">
                            <value>
                                <![CDATA[
                                create function dbo.$(functionName)(@unused smallint) returns smallint as
                                begin
                                    declare @clientapplname varchar(50)
                                    select @clientapplname = clientapplname from master.dbo.sysprocesses where spid = @@spid
                                    if @clientapplname = 'SymmetricDS'
                                        return 1
                                    return 0
                                end
                                ]]>
                            </value>
                        </entry>
                        <entry key="node_disabled">
                            <value>
                                <![CDATA[
                                create function dbo.$(functionName)(@unused smallint) returns varchar(50) as
                                begin
                                    declare @clientname varchar(50)
                                    select @clientname = clientname from master.dbo.sysprocesses where spid = @@spid and clientapplname = 'SymmetricDS'
                                    return @clientname
                                end
                                ]]>
                            </value>
                        </entry>
                        <entry key="txid">
                            <value>
                                <![CDATA[
                                create function dbo.$(functionName)(@unused smallint) returns varchar(50) as
                                begin
                                    declare @txid varchar(50)
                                    if (@@TRANCOUNT > 0) begin
                                        select @txid = convert(varchar, starttime, 20) + '.' + convert(varchar, loid) from master.dbo.systransactions where spid = @@spid
                                    end
                                    return @txid
                                end
                                ]]>
                            </value>
                        </entry>
                    </map>
                </property>
                <property name="stringColumnTemplate">
		            <value>
		                <![CDATA[ case when $(tableAlias)."$(columnName)" is null then '' else '"' + str_replace(str_replace($(tableAlias)."$(columnName)",'\','\\'),'"','\"') + '"' end ]]>
		            </value>
                </property>
                <property name="clobColumnTemplate">
                    <value>
                        <![CDATA[ case when $(origTableAlias)."$(columnName)" is null then '' else '"' + str_replace(str_replace(cast($(origTableAlias)."$(columnName)" as varchar(16384)),'\','\\'),'"','\"') + '"' end ]]>
                    </value>
                </property>
                <property name="emptyColumnTemplate">
                    <value>
                        <![CDATA[ '']]>
                    </value>
                </property>                
                <property name="blobColumnTemplate">
                    <value>
                        <![CDATA[ case when $(origTableAlias)."$(columnName)" is null then '' else '"' + str_replace(str_replace(dbo.$[sym.sync.table.prefix]_base64_encode($(origTableAlias)."$(columnName)"),'\','\\'),'"','\"') + '"' end ]]>
                    </value>
                </property>
                <property name="numberColumnTemplate">
                    <value>
                        <![CDATA[case when $(tableAlias)."$(columnName)" is null then '' else ('"' + cast($(tableAlias)."$(columnName)" as varchar) + '"') end]]>
                    </value>
                </property>
                <property name="datetimeColumnTemplate">
                    <value>
                        <![CDATA[case when $(tableAlias)."$(columnName)" is null then '' else ('"' + str_replace(convert(varchar,$(tableAlias)."$(columnName)",23),'T',' ') + '"') end ]]>
                    </value>
                </property>
                <property name="booleanColumnTemplate">
                    <value>
                        <![CDATA[case when $(tableAlias)."$(columnName)" is null then '' when $(tableAlias)."$(columnName)" = 1 then '"1"' else '"0"' end ]]>
                    </value>
                </property>
                <property name="triggerConcatCharacter" value="+" />
                <property name="newTriggerValue" value="inserted" />
                <property name="oldTriggerValue" value="deleted" />
                <property name="sqlTemplates">
                    <map>
                        <entry key="insertTriggerTemplate">
                            <value>
                                <![CDATA[
                                create trigger $(triggerName) on $(schemaName)$(tableName) for insert as
                                begin
                                  declare @DataRow varchar(16384)
                                  $(declareNewKeyVariables)
                                  if ($(syncOnIncomingBatchCondition)) begin
                                    declare DataCursor cursor for
                                    $(if:containsBlobClobColumns)
                                       select $(columns), $(newKeyNames) from inserted inner join $(schemaName)$(tableName) $(origTableAlias) on $(tableNewPrimaryKeyJoin) where $(syncOnInsertCondition)
                                    $(else:containsBlobClobColumns)
                                       select $(columns), $(newKeyNames) from inserted where $(syncOnInsertCondition)                                    
                                    $(end:containsBlobClobColumns)                                    
                                       open DataCursor
                                       fetch next from DataCursor into @DataRow, $(newKeyVariables)
                                       while @@FETCH_STATUS = 0 begin
                                           insert into $(defaultCatalog)$(defaultSchema)$(prefixName)_data (table_name, event_type, trigger_hist_id, row_data, channel_id, transaction_id, source_node_id, external_data, create_time) 
                                             values('$(targetTableName)','I', $(triggerHistoryId), @DataRow, '$(channelName)', $(txIdExpression), $(defaultCatalog)dbo.$[sym.sync.table.prefix]_node_disabled(0), $(externalSelect), getdate())                                   
                                           fetch next from DataCursor into @DataRow, $(newKeyVariables)
                                       end
                                       close DataCursor
                                       deallocate DataCursor
                                  end
                                end                                
                                ]]>
                            </value>
                        </entry>
                        <entry key="updateTriggerTemplate">
                            <value>
                                <![CDATA[                                
                                create trigger $(triggerName) on $(schemaName)$(tableName) for update as
                                begin
                                  declare @DataRow varchar(16384)
                                  declare @OldPk varchar(2000)
                                  declare @OldDataRow varchar(16384)
                                  $(declareOldKeyVariables)
                                  $(declareNewKeyVariables)
                                  if ($(syncOnIncomingBatchCondition)) begin
                                    declare DataCursor cursor for
                                    $(if:containsBlobClobColumns)
                                       select $(columns), $(oldKeys), $(oldColumns), $(oldKeyNames), $(newKeyNames) from inserted inner join $(schemaName)$(tableName) $(origTableAlias) on $(tableNewPrimaryKeyJoin) inner join deleted on $(oldNewPrimaryKeyJoin) where $(syncOnUpdateCondition)
                                    $(else:containsBlobClobColumns)
                                       select $(columns), $(oldKeys), $(oldColumns), $(oldKeyNames), $(newKeyNames) from inserted inner join deleted on $(oldNewPrimaryKeyJoin) where $(syncOnUpdateCondition)                                    
                                    $(end:containsBlobClobColumns)
                                       open DataCursor
                                       fetch next from DataCursor into @DataRow, @OldPk, @OldDataRow, $(oldKeyVariables), $(newKeyVariables)
                                       while @@FETCH_STATUS = 0 begin                                   
                                         insert into $(defaultCatalog)$(defaultSchema)$(prefixName)_data (table_name, event_type, trigger_hist_id, row_data, pk_data, old_data, channel_id, transaction_id, source_node_id, external_data, create_time) 
                                           values('$(targetTableName)','U', $(triggerHistoryId), @DataRow, @OldPk, @OldDataRow, '$(channelName)', $(txIdExpression), $(defaultCatalog)dbo.$[sym.sync.table.prefix]_node_disabled(0), $(externalSelect), getdate())
                                         fetch next from DataCursor into @DataRow, @OldPk, @OldDataRow, $(oldKeyVariables), $(newKeyVariables)
                                       end
                                       close DataCursor
                                       deallocate DataCursor
                                    end
                                  end                                  
                                ]]>
                            </value>
                        </entry>
                        <entry key="deleteTriggerTemplate">
                            <value>
                                <![CDATA[
                                create trigger $(triggerName) on $(schemaName)$(tableName) for delete as
                                begin
                                  declare @OldPk varchar(2000)
                                  declare @OldDataRow varchar(16384)
                                  $(declareOldKeyVariables)
                                  if ($(syncOnIncomingBatchCondition)) begin
                                    declare DataCursor cursor for
                                      select $(oldKeys), $(oldColumns), $(oldKeyNames) from deleted where $(syncOnDeleteCondition)
                                      open DataCursor
                                       fetch next from DataCursor into @OldPk, @OldDataRow, $(oldKeyVariables)
                                       while @@FETCH_STATUS = 0 begin 
                                         insert into $(defaultCatalog)$(defaultSchema)$(prefixName)_data (table_name, event_type, trigger_hist_id, pk_data, old_data, channel_id, transaction_id, source_node_id, external_data, create_time) 
                                           values('$(targetTableName)','D', $(triggerHistoryId), @OldPk, @OldDataRow, '$(channelName)', $(txIdExpression), $(defaultCatalog)dbo.$[sym.sync.table.prefix]_node_disabled(0), $(externalSelect), getdate())
                                         fetch next from DataCursor into @OldPk,@OldDataRow, $(oldKeyVariables)
                                       end
                                       close DataCursor
                                       deallocate DataCursor
                                  end
                                end                                   
                                ]]>
                            </value>
                        </entry>
                        <entry key="initialLoadSqlTemplate">
                            <value>
                                <![CDATA[select $(columns) from $(schemaName)$(tableName) t where $(whereClause)]]>
                            </value>
                        </entry>
                    </map>
                </property>
            </bean>
        </property>
    </bean>

</beans>
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:util="http://www.springframework.org/schema/util"
  xsi:schemaLocation="    
    http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
    http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.5.xsd"
  default-lazy-init="true">

  <util:map id="rootConfigChannelInitialLoadSelect">
    <!-- Lets keep it simple.  Sync the configuration to everyone for everyone. -->
    <entry key="$[sym.sync.table.prefix]_node_group">
      <value>1=1</value>
    </entry>
    <entry key="$[sym.sync.table.prefix]_node_group_link">
      <value>1=1</value>
    </entry>
    <entry key="$[sym.sync.table.prefix]_parameter">
      <value>1=1</value>
    </entry>
    <entry key="$[sym.sync.table.prefix]_channel">
      <value>1=1</value>
    </entry>
    <entry key="$[sym.sync.table.prefix]_trigger">
      <value>1=1</value>
    </entry> 
    <entry key="$[sym.sync.table.prefix]_node">
      <value>
        node_id = '$(nodeId)' or node_id = (select node_id from $[sym.sync.table.prefix]_node_identity) 
        or ((node_group_id in (select source_node_group_id from
        $[sym.sync.table.prefix]_node_group_link where target_node_group_id = '$(groupId)') or
        node_group_id in (select target_node_group_id from $[sym.sync.table.prefix]_node_group_link
        where source_node_group_id = '$(groupId)')) and created_at_node_id = (select node_id from $[sym.sync.table.prefix]_node_identity))
      </value>
    </entry>
    <entry key="$[sym.sync.table.prefix]_node_security">
      <value>
        node_id = '$(nodeId)' 
        or node_id in (select s.node_id from $[sym.sync.table.prefix]_node s inner join $[sym.sync.table.prefix]_node_group_link l 
          on s.node_group_id = l.source_node_group_id
          where l.target_node_group_id = '$(groupId)' 
          and s.created_at_node_id=(select node_id from $[sym.sync.table.prefix]_node_identity)) 
        or node_id in (select s.node_id from $[sym.sync.table.prefix]_node s inner join $[sym.sync.table.prefix]_node_group_link l 
          on s.node_group_id = l.target_node_group_id 
          where l.source_node_group_id = '$(groupId)'
          and s.created_at_node_id=(select node_id from $[sym.sync.table.prefix]_node_identity))
      </value>
    </entry>   
    <entry key="$[sym.sync.table.prefix]_node_channel_ctl">
      <value>node_id in (select s.node_id from $[sym.sync.table.prefix]_node s where s.created_at_node_id=(select node_id from $[sym.sync.table.prefix]_node_identity))</value>
    </entry>
  </util:map>

  <util:map id="triggerServiceSql">
    <entry key="inactivateTriggerHistorySql">
      <value>
        update $[sym.sync.table.prefix]_trigger_hist set inactive_time = current_timestamp where
        trigger_hist_id=?
      </value>
    </entry>
    <entry key="selectGroupTriggersSql">
      <value>
        select * from $[sym.sync.table.prefix]_trigger where source_node_group_id = ? order by
        channel_id
      </value>
    </entry>
    <entry key="activeTriggersForSourceNodeGroupSql">
      <value>
        select * from $[sym.sync.table.prefix]_trigger where source_node_group_id = ? and inactive_time
        is null
      </value>
    </entry>
    <entry key="activeTriggersForReloadSql">
      <value>
        select * from $[sym.sync.table.prefix]_trigger where source_node_group_id = ? and
        target_node_group_id = ? and channel_id != ? and inactive_time is null order by
        initial_load_order
      </value>
    </entry>
    <entry key="inactiveTriggersForSourceNodeGroupSql">
      <value>
        select * from $[sym.sync.table.prefix]_trigger t where t.source_node_group_id =
        ? and t.inactive_time is not null
      </value>
    </entry>
    <entry key="allTriggerHistSql">
      <value>
        select trigger_hist_id,trigger_id,source_table_name,table_hash,create_time,pk_column_names,column_names,last_trigger_build_reason,name_for_delete_trigger,name_for_insert_trigger,name_for_update_trigger,source_schema_name,source_catalog_name,trigger_row_hash
        from $[sym.sync.table.prefix]_trigger_hist </value>
    </entry>
    <entry key="triggerHistBySourceTableWhereSql">
      <value> where source_table_name=? and inactive_time is null</value>
    </entry>    
    <entry key="latestTriggerHistSql">
      <value>
        select
        trigger_hist_id,trigger_id,source_table_name,table_hash,create_time,pk_column_names,column_names,last_trigger_build_reason,name_for_delete_trigger,name_for_insert_trigger,name_for_update_trigger,source_schema_name,source_catalog_name,trigger_row_hash 
        from $[sym.sync.table.prefix]_trigger_hist where trigger_hist_id = (select max(trigger_hist_id)
        from $[sym.sync.table.prefix]_trigger_hist where trigger_id=?)
      </value>
    </entry>
    <entry key="triggerHistSql">
      <value>
        select
        trigger_hist_id,trigger_id,source_table_name,table_hash,create_time,pk_column_names,column_names,last_trigger_build_reason,name_for_delete_trigger,name_for_insert_trigger,name_for_update_trigger,source_schema_name,source_catalog_name,trigger_row_hash
        from $[sym.sync.table.prefix]_trigger_hist where trigger_hist_id = ?
      </value>
    </entry>
    <entry key="insertTriggerHistorySql">
      <value>
        insert into $[sym.sync.table.prefix]_trigger_hist
        (trigger_id,source_table_name,table_hash,create_time,column_names,pk_column_names,last_trigger_build_reason,name_for_delete_trigger,name_for_insert_trigger,name_for_update_trigger,source_schema_name,source_catalog_name,trigger_row_hash)
        values(?,?,?,?,?,?,?,?,?,?,?,?,?)
      </value>
    </entry>
    <entry key="insertTriggerSql">
      <value>
        insert into $[sym.sync.table.prefix]_trigger
        (source_catalog_name,source_schema_name,source_table_name,target_catalog_name,target_schema_name,target_table_name,source_node_group_id,target_node_group_id,channel_id,sync_on_update,sync_on_insert,sync_on_delete,sync_on_incoming_batch,name_for_update_trigger,name_for_insert_trigger,name_for_delete_trigger,sync_on_update_condition,sync_on_insert_condition,sync_on_delete_condition,router_name,router_expression,tx_id_expression,excluded_column_names,initial_load_select,initial_load_order,create_time,inactive_time,last_update_by,last_update_time)
        values(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)
      </value>
    </entry>
    <entry key="updateTriggerSql">
      <value>
        update $[sym.sync.table.prefix]_trigger
         set source_catalog_name=?,source_schema_name=?,source_table_name=?,
         target_catalog_name=?,target_schema_name=?,target_table_name=?,source_node_group_id=?,
         target_node_group_id=?,channel_id=?,sync_on_update=?,sync_on_insert=?,sync_on_delete=?,
         sync_on_incoming_batch=?,name_for_update_trigger=?,name_for_insert_trigger=?,
         name_for_delete_trigger=?,sync_on_update_condition=?,sync_on_insert_condition=?,
         sync_on_delete_condition=?,router_name=?,router_expression=?,tx_id_expression=?,excluded_column_names=?,
         initial_load_select=?,initial_load_order=?,create_time=?,inactive_time=?,last_update_by=?,last_update_time=?
        where trigger_id=?
      </value>
    </entry>            
    <entry key="selectTriggerSql">
      <value>
        select * from $[sym.sync.table.prefix]_trigger where source_table_name = ? and
        source_node_group_id = ?
      </value>
    </entry>
    <entry key="selectTriggerTargetSql">
      <value>
        select * from $[sym.sync.table.prefix]_trigger where source_table_name = ? and
        target_node_group_id = ? and channel_id = ? and source_node_group_id = ?
      </value>
    </entry>
    <entry key="selectTriggerByIdSql">
      <value>select * from $[sym.sync.table.prefix]_trigger where trigger_id = ?</value>
    </entry>
  </util:map>

</beans>